import{a as l}from"./chunks/index.xsH4HHeE.js";const w=new Map,g=10*60*1e3,m=8;let a=0;window.addEventListener("message",async t=>{if(t.origin===window.location.origin&&t.data.type==="START_MONITORING"){const{url:e,sessionId:n,totalRuns:o=8}=t.data;console.log(`started monitoring for ${e} - Session: ${n}`),w.set(n,{totalRuns:o,currentRun:0}),window.postMessage({type:"MONITORING_STARTED",sessionId:n,url:e},"*"),await T(e,n,0,o)}});function T(t,e,n,o){a=0,chrome.storage.local.set({[t]:{status:"Active",startedAt:Date.now(),sessionId:e}}),console.log(`Starting timed monitoring for ${t} - ${m} runs over ${m*g/6e4} minutes`);for(let s=n;s<o;s++)setTimeout(async()=>{a=s+1,console.log(`Running ping ${a} of ${m} for ${t}`),await D(t,e,a,o)},s*g);setTimeout(()=>{chrome.storage.local.set({[t]:{status:"Completed",startedAt:Date.now()}}),console.log("Monitoring completed for:",t)},m*g+5e3)}async function D(t,e,n,o){const s=performance.now();let r;try{performance.clearResourceTimings();const i=await l.get(t,{timeout:3e4,headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});await new Promise(d=>setTimeout(d,1e3));const p=performance.getEntriesByType("resource"),u=performance.getEntriesByType("navigation")[0];let c=null;c=p.find(d=>d.name===t)||null,!c&&u&&(c=u),c?r=A(c,i.status):r={dnsLookup:0,tcpConnection:0,tlsHandshake:0,ttfb:0,contentDownload:0,totalDuration:performance.now()-s,statusCode:i.status};const f={pingData:{[t]:r}};chrome.runtime.sendMessage({action:"PERF_DATA",url:t,data:f,timestamp:Date.now(),runNumber:a,totalRuns:o}),console.log(`Performance data sent for run ${a}:`,r),window.postMessage({type:"MONITORING_UPDATE",sessionId:e,url:t,runNumber:n,totalRuns:o,success:!0,statusCode:r.statusCode,responseTime:r.totalDuration,timestamp:Date.now()},"*"),n===o&&chrome.storage.local.set({[t]:{status:"Completed",startedAt:Date.now(),sessionId:e}})}catch(i){console.error(`Failed to collect performance data for run ${a}:`,i);const p={pingData:{[t]:{dnsLookup:0,tcpConnection:0,tlsHandshake:0,ttfb:0,contentDownload:0,totalDuration:0,statusCode:0}}};chrome.runtime.sendMessage({action:"PERF_DATA",url:t,data:p,timestamp:Date.now(),runNumber:a,totalRuns:o,error:i||"Request failed"}),window.postMessage({type:"MONITORING_UPDATE",sessionId:e,url:t,runNumber:n,totalRuns:o,success:!0,statusCode:404,responseTime:0,timestamp:Date.now()},"*"),n===o&&chrome.storage.local.set({[t]:{status:"Completed",startedAt:Date.now(),sessionId:e}})}}function A(t,e){return{dnsLookup:t.domainLookupEnd-t.domainLookupStart,tcpConnection:t.connectEnd-t.connectStart,tlsHandshake:t.secureConnectionStart>0?t.connectEnd-t.secureConnectionStart:0,ttfb:t.responseStart-t.requestStart,contentDownload:t.responseEnd-t.responseStart,totalDuration:t.responseEnd-t.startTime,statusCode:e}}
