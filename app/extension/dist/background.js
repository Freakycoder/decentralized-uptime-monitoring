import{a}from"./chunks/index.xsH4HHeE.js";class u{constructor(){this.monitoredWebsites={},this.INTERVAL=10*60*1e3,this.SERVER_ENDPOINT="http://127.0.0.1:3001",this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener((t,i,e)=>{var r;if(t.action==="MONITOR_URL"&&t.url)this.startMonitoring(t.url),e({success:!0});else if(t.action==="PERF_DATA"&&t.url&&t.data){const o=t.data.pingData[t.url],n={url:t.url,timestamp:new Date().toISOString(),runNumber:t.runNumber,totalRuns:t.totalRuns,dnsLookup:o.dnsLookup,tcpConnection:o.tcpConnection,tlsHandshake:o.tlsHandshake,ttfb:o.ttfb,contentDownload:o.contentDownload,totalDuration:o.totalDuration,statusCode:o.statusCode,extensionSessionId:this.generateSessionId(),checkCount:((r=this.monitoredWebsites[new URL(t.url).origin])==null?void 0:r.checkCount)||0};try{a.post(`${this.SERVER_ENDPOINT}/ws/upgrade`,n),console.log("Performance data sent to server:",n)}catch(s){console.error("Failed to send performance data:",s)}e({success:!0})}else if(t.action==="GET_MONITORED_SITES"){const o=Object.values(this.monitoredWebsites).map(n=>({url:n.url,domain:new URL(n.url).hostname,isActive:n.checkCount<8&&n.timeouts.length>0,checkCount:n.checkCount,startTime:n.startTime,lastUpdate:new Date().toISOString()}));e({sites:o})}return!0})}startMonitoring(t){const i=new URL(t);if(this.monitoredWebsites[i.origin]){console.log(`already monitoring : ${i.origin}`);return}const e={url:i.origin,startTime:0,checkCount:0,timeouts:[]};for(let r=0;r<8;r++){const o=setTimeout(()=>{chrome.tabs.create({url:e.url,active:!1}),e.checkCount++,e.startTime=Date.now()},r*this.INTERVAL);e.timeouts.push(o)}this.monitoredWebsites[i.origin]=e,console.log(`started monitoring : ${t}`)}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}new u;
