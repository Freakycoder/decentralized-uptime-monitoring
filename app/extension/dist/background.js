import{a as d}from"./chunks/index.xsH4HHeE.js";class l{constructor(){this.monitoredWebsites={},this.INTERVAL=10*60*1e3,this.SERVER_ENDPOINT="http://127.0.0.1:3001",this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener((t,r,o)=>{var i;if(t.action==="MONITOR_URL"&&t.url)this.startMonitoring(t.url),o({success:!0});else if(t.action==="PERF_DATA"&&t.url&&t.data){const a=localStorage.get("validator_connection_data"),c=JSON.parse(a).validatorId,e=t.data.pingData[t.url],s={website_id:e.website_id,validator_id:c,timestamp:new Date().toISOString(),runNumber:t.runNumber,totalRuns:t.totalRuns,dnsLookup:e.dnsLookup,tcpConnection:e.tcpConnection,tlsHandshake:e.tlsHandshake,ttfb:e.ttfb,contentDownload:e.contentDownload,totalDuration:e.totalDuration,statusCode:e.statusCode,extensionSessionId:this.generateSessionId(),checkCount:((i=this.monitoredWebsites[new URL(t.url).origin])==null?void 0:i.checkCount)||0};try{d.post(`${this.SERVER_ENDPOINT}/ws/upgrade`,s),console.log("Performance data sent to server:",s)}catch(u){console.error("Failed to send performance data:",u)}o({success:!0})}else if(t.action==="GET_MONITORED_SITES"){const a=Object.values(this.monitoredWebsites).map(n=>({url:n.url,domain:new URL(n.url).hostname,isActive:n.checkCount<8&&n.timeouts.length>0,checkCount:n.checkCount,startTime:n.startTime,lastUpdate:new Date().toISOString()}));o({sites:a})}return!0})}startMonitoring(t){const r=new URL(t);if(this.monitoredWebsites[r.origin]){console.log(`already monitoring : ${r.origin}`);return}const o={url:r.origin,startTime:0,checkCount:0,timeouts:[]};for(let i=0;i<8;i++){const a=setTimeout(()=>{chrome.tabs.create({url:o.url,active:!1}),o.checkCount++,o.startTime=Date.now()},i*this.INTERVAL);o.timeouts.push(a)}this.monitoredWebsites[r.origin]=o,console.log(`started monitoring : ${t}`)}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}new l;
